<% 
  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  preselected_folder_id = @preselected_folder_id
  preselected_project_id = @preselected_project_id
  preselected_folder_name = @preselected_folder_name
%>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ -->
<div id="upload-image-modal" class="fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto" style="background: rgba(3, 5, 10, 0.95); backdrop-filter: blur(8px);" onclick="if(event.target === this) closeUploadModal()">
  <div class="print-card w-full max-w-[95vw] sm:max-w-2xl mx-2 sm:mx-4 my-2 sm:my-8" style="background: var(--panel-raise); border: 2px solid var(--accent-electric); max-height: 95vh; overflow-y: auto;" onclick="event.stopPropagation()">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="flex items-center justify-between p-4 sm:p-6 border-b sticky top-0" style="background: var(--panel-raise); border-color: var(--border-sharp); z-index: 10;">
      <h2 class="text-lg sm:text-xl md:text-2xl font-semibold uppercase tracking-tight neon-electric">–ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û</h2>
      <button type="button" id="closeModalBtn" class="w-10 h-10 sm:w-8 sm:h-8 flex items-center justify-center transition-all hover:opacity-70 min-w-[44px] min-h-[44px]" style="color: var(--text-secondary);">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div class="p-4 sm:p-6">
      <%= form_with model: @image, url: projects_path, method: :post, multipart: true, class: "space-y-6", data: { turbo: false }, id: "uploadForm" do |f| %>
        <%= render "shared/error_messages", resource: @image %>

        <!-- Drag and Drop –∑–æ–Ω–∞ -->
        <div class="file-input-wrapper">
          <div class="drop-zone p-6 sm:p-8 md:p-12 text-center cursor-pointer relative border-2 border-dashed transition-all" id="dropZone" style="background: var(--panel-deep); border-color: var(--border-sharp);">
            <div id="dropZoneContent">
              <div class="text-4xl sm:text-5xl md:text-6xl mb-3 sm:mb-4">üì∑</div>
              <p class="font-bold text-base sm:text-lg mb-2" style="color: var(--text-primary);">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞</p>
              <p class="text-xs sm:text-sm mb-3 sm:mb-4" style="color: var(--text-muted);">–∏–ª–∏</p>
              <button type="button" class="btn-outlined inline-block text-xs sm:text-sm py-2 sm:py-2.5 px-3 sm:px-4 min-h-[44px]" id="selectFileBtn">–í–´–ë–†–ê–¢–¨ –§–ê–ô–õ</button>
              <p class="text-xs mt-3 sm:mt-4" style="color: var(--text-muted);">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, WebP</p>
            </div>
            <div id="fileInfo" class="hidden">
              <div class="mb-4">
                <img id="filePreview" src="" alt="Preview" class="max-w-full max-h-64 mx-auto rounded" style="display: none;">
                <div id="fileIcon" class="text-4xl">‚úÖ</div>
              </div>
              <p class="font-bold text-lg mb-2" id="fileName" style="color: var(--text-primary);"></p>
              <p class="text-sm mb-4" id="fileSize" style="color: var(--text-muted);"></p>
              <div class="flex items-center justify-center gap-4">
                <button type="button" class="text-sm font-semibold uppercase transition-colors" id="removeFile" style="color: var(--accent-blue);">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </div>
            <%= f.file_field :file, accept: "image/*", class: "absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10", required: true, id: "fileInput" %>
          </div>
        </div>

        <!-- –ü—Ä–æ–µ–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
        <div>
          <%= f.label :project_id, "–ü–†–û–ï–ö–¢", class: "block text-xs font-semibold uppercase tracking-wider mb-2", style: "color: var(--text-muted); letter-spacing: 1px;" %>
          <%= f.collection_select :project_id, 
              @projects || current_user.projects.active, 
              :id, 
              :name,
              { prompt: "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", include_blank: true, selected: preselected_project_id },
              { class: "w-full px-4 py-3 text-sm uppercase tracking-wider", 
                style: "background: var(--panel-deep); border: 2px solid var(--border-sharp); color: var(--text-primary); letter-spacing: 1px; border-radius: 0;",
                id: "project_select" } %>
          <p class="text-xs mt-1" style="color: var(--text-muted);">–ü—Ä–æ–µ–∫—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω. –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞.</p>
        </div>
        
        <!-- –ö–æ–º–Ω–∞—Ç–∞ / –ü–∞–ø–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
        <div>
          <%= f.label :folder_id, "–ö–û–ú–ù–ê–¢–ê / –ü–ê–ü–ö–ê", class: "block text-xs font-semibold uppercase tracking-wider mb-2", style: "color: var(--text-muted); letter-spacing: 1px;" %>
          <%= f.collection_select :folder_id, 
              (@projects&.first&.folders&.ordered || []),
              :id, 
              :name,
              { prompt: "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –ø–∞–ø–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)", include_blank: true, selected: preselected_folder_id },
              { class: "w-full px-4 py-3 text-sm uppercase tracking-wider", 
                style: "background: var(--panel-deep); border: 2px solid var(--border-sharp); color: var(--text-primary); letter-spacing: 1px; border-radius: 0;",
                id: "folder_select" } %>
          <% if preselected_folder_name %>
            <p class="text-xs mt-1 neon-electric">‚úì –í—ã–±—Ä–∞–Ω–æ: <%= preselected_folder_name %></p>
          <% else %>
            <p class="text-xs mt-1" style="color: var(--text-muted);">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–æ–º–Ω–∞—Ç—ã –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ç–æ</p>
          <% end %>
          <p class="text-xs mt-1" id="folder-hint" style="color: var(--accent-electric); display: none;">
            <span id="folder-count">0</span> –∫–æ–º–Ω–∞—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ
          </p>
        </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-4">
              <%= f.submit "–ó–ê–ì–†–£–ó–ò–¢–¨", class: "btn-flash flex-1 text-sm py-3 min-h-[44px] flex items-center justify-center", id: "submitBtn" %>
              <button type="button" id="cancelBtn" class="btn-outlined flex-1 text-center text-sm py-3 min-h-[44px] flex items-center justify-center">
                –û–¢–ú–ï–ù–ê
              </button>
            </div>
      <% end %>
      
      <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
      <div id="uploadProgress" class="hidden mt-4 print-card p-4" style="background: var(--panel-deep);">
        <div class="flex items-center space-x-3">
          <div class="animate-spin rounded-full h-5 w-5 border-b-2" style="border-color: var(--accent-electric);"></div>
          <p class="font-bold" style="color: var(--text-primary);">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ
  function closeUploadModal() {
    const modal = document.getElementById('upload-image-modal');
    if (modal) {
      modal.style.opacity = '0';
      modal.style.transition = 'opacity 0.2s ease-out';
      setTimeout(() => {
        modal.remove();
      }, 200);
    }
  }
  
  // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π
  window.closeUploadModal = closeUploadModal;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  function initUploadModalHandlers() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const modal = document.getElementById('upload-image-modal');
    if (!modal) return;
    
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const dropZoneContent = document.getElementById('dropZoneContent');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFileBtn = document.getElementById('removeFile');
    const projectSelect = document.getElementById('project_select');
    const folderSelect = document.getElementById('folder_select');
    const submitBtn = document.getElementById('submitBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è (–∫—Ä–µ—Å—Ç–∏–∫)
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeUploadModal();
      });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û–¢–ú–ï–ù–ê"
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeUploadModal();
        return false;
      });
    }

    // –î–∞–Ω–Ω—ã–µ –æ –ø–∞–ø–∫–∞—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
    const foldersData = {};
    <% (@projects || current_user.projects.active.includes(:folders)).each do |project| %>
    foldersData['<%= project.id %>'] = [
      <% project.folders.ordered.each do |folder| %>
      { id: <%= folder.id %>, name: <%= folder.name.to_json.html_safe %> },
      <% end %>
    ];
    <% end %>

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ input
    fileInput.addEventListener('change', function(e) {
      handleFileSelect(e.target.files);
    });

    // –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É "–í–´–ë–†–ê–¢–¨ –§–ê–ô–õ"
    const selectFileBtn = document.getElementById('selectFileBtn');
    if (selectFileBtn) {
      selectFileBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileInput.click();
      });
    }

    // –ö–ª–∏–∫ –Ω–∞ drop zone —Ç–∞–∫–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç file picker
    dropZone.addEventListener('click', function(e) {
      if (e.target.id === 'removeFile' || e.target.closest('#removeFile')) {
        return;
      }
      if (e.target.id === 'selectFileBtn' || e.target.closest('#selectFileBtn')) {
        return;
      }
      fileInput.click();
    });

    // Drag and Drop
    dropZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      dropZone.style.borderColor = 'var(--accent-electric)';
      dropZone.style.background = 'rgba(0, 224, 255, 0.1)';
    });

    dropZone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
      dropZone.style.borderColor = 'var(--border-sharp)';
      dropZone.style.background = 'var(--panel-deep)';
    });

    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      dropZone.style.borderColor = 'var(--border-sharp)';
      dropZone.style.background = 'var(--panel-deep)';
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect(files);
      }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    function handleFileSelect(files) {
      if (files && files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('image/')) {
          dropZone.style.borderColor = 'var(--accent-electric)';
          dropZoneContent.classList.add('hidden');
          fileInfo.classList.remove('hidden');
          
          fileName.textContent = file.name;
          fileSize.textContent = formatFileSize(file.size);
          
          const filePreview = document.getElementById('filePreview');
          const fileIcon = document.getElementById('fileIcon');
          const reader = new FileReader();
          
          reader.onload = function(e) {
            filePreview.src = e.target.result;
            filePreview.style.display = 'block';
            fileIcon.style.display = 'none';
          };
          
          reader.readAsDataURL(file);
        } else {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        }
      }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
    if (removeFileBtn) {
      removeFileBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileInput.value = '';
        dropZone.style.borderColor = 'var(--border-sharp)';
        dropZoneContent.classList.remove('hidden');
        fileInfo.classList.add('hidden');
        
        const filePreview = document.getElementById('filePreview');
        const fileIcon = document.getElementById('fileIcon');
        if (filePreview) {
          filePreview.src = '';
          filePreview.style.display = 'none';
        }
        if (fileIcon) {
          fileIcon.style.display = 'block';
        }
      });
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–ø–æ–∫ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞
    if (projectSelect && folderSelect) {
      projectSelect.addEventListener('change', function() {
        const projectId = this.value;
        const folders = foldersData[projectId] || [];
        
        folderSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –ø–∞–ø–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>';
        folderSelect.value = '';
        
        const folderHint = document.getElementById('folder-hint');
        const folderCount = document.getElementById('folder-count');
        
        if (folders.length > 0) {
          folders.forEach(function(folder) {
            const option = document.createElement('option');
            option.value = folder.id.toString();
            option.textContent = folder.name;
            folderSelect.appendChild(option);
          });
          
          if (folderHint && folderCount) {
            folderCount.textContent = folders.length;
            folderHint.style.display = 'block';
          }
        } else {
          if (folderHint) {
            folderHint.style.display = 'none';
          }
        }
      });
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫
      <% if @preselected_project_id %>
        // –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω, –≤—ã–±–∏—Ä–∞–µ–º –µ–≥–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞–ø–∫–∏
        setTimeout(function() {
          projectSelect.value = '<%= @preselected_project_id %>';
          projectSelect.dispatchEvent(new Event('change'));
          
          // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞, –≤—ã–±–∏—Ä–∞–µ–º –µ—ë
          <% if @preselected_folder_id %>
            setTimeout(function() {
              folderSelect.value = '<%= @preselected_folder_id %>';
            }, 150);
          <% end %>
        }, 100);
      <% elsif @preselected_folder_id %>
        // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –ø–∞–ø–∫–∞ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∞, –Ω–∞—Ö–æ–¥–∏–º –µ—ë –ø—Ä–æ–µ–∫—Ç
        <% if @preselected_project_id %>
          setTimeout(function() {
            projectSelect.value = '<%= @preselected_project_id %>';
            projectSelect.dispatchEvent(new Event('change'));
            setTimeout(function() {
              folderSelect.value = '<%= @preselected_folder_id %>';
            }, 150);
          }, 100);
        <% end %>
      <% else %>
        // –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤—ã–±—Ä–∞–Ω –≤—Ä—É—á–Ω—É—é, –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞–ø–∫–∏
        if (projectSelect.value) {
          setTimeout(function() {
            projectSelect.dispatchEvent(new Event('change'));
          }, 100);
        }
      <% end %>
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
      uploadForm.addEventListener('submit', function(e) {
        if (!fileInput.files || fileInput.files.length === 0) {
          e.preventDefault();
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
          return false;
        }
        
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = '–ó–ê–ì–†–£–ó–ö–ê...';
        }
        if (uploadProgress) {
          uploadProgress.classList.remove('hidden');
        }
        
        // –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º (–Ω–µ —á–µ—Ä–µ–∑ fetch)
        // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –¥–∞—à–±–æ—Ä–¥
        // –ú–æ–¥–∞–ª–∫–∞ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ
      });
    }
  }

  // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–π
  window.initUploadModalHandlers = initUploadModalHandlers;
  
  // –í—ã–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å—Ä–∞–∑—É (–¥–ª—è —Å–ª—É—á–∞—è, –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–∂–µ –≤ DOM)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initUploadModalHandlers);
  } else {
    // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –≤—ã–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
    initUploadModalHandlers();
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫)
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('upload-image-modal');
      if (modal && modal.style.display !== 'none' && !modal.classList.contains('hidden')) {
        closeUploadModal();
      }
    }
  });
</script>
