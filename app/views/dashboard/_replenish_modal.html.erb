<% @token_packages = TokenPackage.active.ordered_by_price %>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ -->
<div id="replenish-modal" class="fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto hidden" style="background: rgba(3, 5, 10, 0.95); backdrop-filter: blur(8px);" onclick="if(event.target === this) closeReplenishModal()">
  <div id="modal-container" class="print-card w-full max-w-[95vw] sm:max-w-6xl mx-2 sm:mx-4 my-4 sm:my-8 relative flex flex-col sm:flex-row transition-all duration-300" style="background: var(--panel-raise); border: 2px solid var(--accent-electric); max-height: 95vh; overflow: hidden;" onclick="event.stopPropagation()">
    
    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="main-content" class="flex-shrink-0 transition-all duration-300" style="width: 100%;">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div class="flex items-center justify-between p-4 sm:p-6 border-b" style="border-color: var(--border-sharp);">
        <h2 class="text-xl sm:text-2xl font-semibold uppercase" style="color: var(--text-primary);">
          <span style="color: var(--accent-electric);">–ü–û–ü–û–õ–ù–ò–¢–¨</span> <span style="color: var(--text-primary);">–ë–ê–õ–ê–ù–°</span>
        </h2>
        <button onclick="closeReplenishModal()" class="w-8 h-8 flex items-center justify-center transition-all hover:opacity-70 min-w-[44px] min-h-[44px]" style="color: var(--text-secondary);">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="p-4 sm:p-6 space-y-4 sm:space-y-6 overflow-y-auto" style="max-height: calc(95vh - 80px);">
        <!-- –ë–ª–æ–∫ —Å –±–∞–ª–∞–Ω—Å–æ–º –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π -->
        <div class="grid grid-cols-2 gap-3 sm:gap-4">
          <div class="print-card p-4" style="background: var(--panel-deep);">
            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted); letter-spacing: 1px;">–ö–†–ï–î–ò–¢–û–í</div>
            <div class="text-3xl font-semibold neon-electric" id="credits-count"><%= @token_balance %></div>
          </div>
          <div class="print-card p-4" style="background: var(--panel-deep);">
            <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted); letter-spacing: 1px;">–û–ë–†–ê–ë–û–¢–ê–ù–û</div>
            <div class="text-3xl font-semibold" style="color: var(--accent-blue);" id="processed-count"><%= @total_photos %></div>
          </div>
        </div>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤ -->
        <div class="flex items-center justify-between">
          <h3 class="text-sm uppercase tracking-wider" style="color: var(--text-muted); letter-spacing: 1px; opacity: 0.7;">–í–´–ë–ï–†–ò–¢–ï –¢–ê–†–ò–§</h3>
          <span class="text-xs" style="color: var(--text-muted); opacity: 0.6;">‚ñº –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–∞—Ä–∏—Ñ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö</span>
        </div>

        <!-- –°–µ—Ç–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="packages-grid">
          <% 
            package_features = {
              '–°–¢–ê–†–¢–û–í–´–ô' => '‚Ä¢ 20 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π ‚Ä¢ 1 –ø—Ä–æ–µ–∫—Ç',
              '–ë–ê–ó–û–í–´–ô' => '‚Ä¢ 60 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π ‚Ä¢ 5 –ø—Ä–æ–µ–∫—Ç–æ–≤ ‚Ä¢ Multi-view',
              '–ü–†–û–§–ò' => '‚Ä¢ 150 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π ‚Ä¢ 15 –ø—Ä–æ–µ–∫—Ç–æ–≤ ‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç',
              '–ê–ì–ï–ù–¢–°–ö–ò–ô' => '‚Ä¢ 500 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π ‚Ä¢ –ë–µ–∑–ª–∏–º–∏—Ç ‚Ä¢ White-label'
            }
          %>
          <% @token_packages.each_with_index do |package, index| %>
            <% 
              accent_colors = [
                'var(--accent-electric)',  # –°–¢–ê–†–¢–û–í–´–ô - –Ω–µ–æ–Ω-—Ü–∏–∞–Ω
                'var(--accent-blue)',       # –ë–ê–ó–û–í–´–ô - —Å–∏–Ω–∏–π
                'var(--accent-electric)',   # –ü–†–û–§–ò - –Ω–µ–æ–Ω-—Ü–∏–∞–Ω
                'var(--accent-blue)'        # –ê–ì–ï–ù–¢–°–ö–ò–ô - —Å–∏–Ω–∏–π
              ]
              accent_color = accent_colors[index % accent_colors.length]
              is_popular = package.name == '–ë–ê–ó–û–í–´–ô'
              features = package_features[package.name] || ''
            %>
            <button 
              type="button"
              onclick="togglePackage(<%= package.id %>, '<%= j(package.name) %>', <%= package.price_dollars %>, '<%= accent_color %>', <%= package.tokens_amount %>)"
              class="package-card print-card p-4 text-left transition-all relative"
              style="background: var(--panel-deep); border: 2px solid var(--border-sharp); cursor: pointer;"
              data-package-id="<%= package.id %>"
              data-package-name="<%= package.name %>"
              data-accent="<%= accent_color %>">
              
              <% if is_popular %>
                <div class="absolute top-0 right-0 px-3 py-1 text-xs font-semibold uppercase" style="background: var(--accent-blue); color: var(--ink); transform: translate(8px, -8px);">
                  –•–ò–¢
                </div>
              <% end %>
              
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-base font-semibold uppercase" style="color: var(--text-primary);">
                  <%= package.name %>
                </h4>
                <span class="package-indicator text-lg transition-transform" style="color: var(--accent-electric);">‚ñº</span>
              </div>
              <div class="text-2xl font-bold mb-1" style="color: <%= accent_color %>;">$<%= package.price_dollars.to_i %></div>
              <div class="text-sm mb-2" style="color: var(--text-secondary);"><%= package.tokens_amount %> —Ç–æ–∫–µ–Ω–æ–≤</div>
              <div class="text-xs" style="color: var(--text-muted);"><%= features %></div>
            </button>
          <% end %>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="flex items-start gap-3 pt-4 border-t" style="border-color: var(--border-sharp);">
          <span class="text-lg">‚ÑπÔ∏è</span>
          <div class="flex-1">
            <p class="text-sm mb-1" style="color: var(--text-secondary);">–¢–æ–∫–µ–Ω—ã –Ω–µ —Å–≥–æ—Ä–∞—é—Ç. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.</p>
            <p class="text-xs" style="color: var(--text-muted);">‚Ä¢ 1 —Ç–æ–∫–µ–Ω = 1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ —Å—Ç–∏–ª—è</p>
          </div>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –ø–∞–Ω–µ–ª—å –æ–ø–ª–∞—Ç—ã (–≤—ã–µ–∑–∂–∞–µ—Ç —Å–ø—Ä–∞–≤–∞) -->
    <div id="payment-panel" class="payment-panel flex-shrink-0 overflow-hidden transition-all duration-300" style="width: 0; border-left: 0 solid var(--border-sharp);">
      <div class="panel-content w-full p-6 space-y-4 overflow-y-auto" style="max-height: calc(90vh - 80px); min-width: 400px;">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏ -->
        <div class="flex items-center justify-between mb-4 pb-4 border-b" style="border-color: var(--border-sharp);">
          <h3 class="text-lg font-semibold uppercase" style="color: var(--text-primary);">–û–ü–õ–ê–¢–ê</h3>
          <button onclick="closePanel()" class="w-6 h-6 flex items-center justify-center transition-all hover:opacity-70" style="color: var(--text-secondary);">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ -->
        <div class="print-card p-4" style="background: var(--panel-deep);">
          <div class="text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted); letter-spacing: 1px;">–í–´–ë–†–ê–ù–û</div>
          <div id="selected-package-name" class="text-xl font-semibold uppercase mb-3" style="color: var(--text-primary);">-</div>
          <div class="flex items-baseline gap-2">
            <div id="selected-package-price" class="text-3xl font-bold" style="color: var(--accent-electric);">-</div>
            <div id="selected-package-tokens" class="text-sm" style="color: var(--text-secondary);">-</div>
          </div>
        </div>

        <!-- –ü—Ä–æ–º–æ-–∫–æ–¥ -->
        <div>
          <h3 class="text-sm uppercase tracking-wider mb-3" style="color: var(--text-muted); letter-spacing: 1px; opacity: 0.7;">–ü–†–û–ú–û-–ö–û–î</h3>
          <div class="flex gap-3">
            <input 
              type="text" 
              id="promo-code" 
              placeholder="–í–í–ï–î–ò–¢–ï –ö–û–î" 
              class="flex-1 px-4 py-3 text-sm uppercase tracking-wider"
              style="background: var(--panel-deep); border: 2px solid var(--accent-electric); color: var(--text-primary); letter-spacing: 1px; border-radius: 0;"
              onfocus="this.style.borderColor='var(--accent-electric)'; this.style.boxShadow='0 0 10px var(--glow-electric)';"
              onblur="this.style.borderColor='var(--accent-electric)'; this.style.boxShadow='none';">
            <button 
              type="button"
              onclick="applyPromoCode()"
              class="px-6 py-3 text-sm font-semibold uppercase tracking-wider transition-all"
              style="background: var(--accent-blue); color: var(--text-primary); border: none; border-radius: 0; letter-spacing: 1px;"
              onmouseover="this.style.background='var(--accent-electric)';"
              onmouseout="this.style.background='var(--accent-blue)';">
              –ü–†–ò–ú–ï–ù–ò–¢–¨
            </button>
          </div>
        </div>

        <!-- –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã -->
        <div>
          <h3 class="text-sm uppercase tracking-wider mb-3" style="color: var(--text-muted); letter-spacing: 1px; opacity: 0.7;">–î–ê–ù–ù–´–ï –ö–ê–†–¢–´</h3>
          <div class="space-y-3">
            <input 
              type="text" 
              id="card-number" 
              placeholder="0000 0000 0000 0000" 
              maxlength="19"
              class="w-full px-4 py-3 text-sm uppercase tracking-wider"
              style="background: var(--panel-deep); border: 2px solid var(--accent-electric); color: var(--text-primary); letter-spacing: 1px; border-radius: 0;"
              onfocus="this.style.borderColor='var(--accent-electric)'; this.style.boxShadow='0 0 10px var(--glow-electric)';"
              onblur="this.style.borderColor='var(--accent-electric)'; this.style.boxShadow='none';"
              oninput="formatCardNumber(this)">
            
            <div class="grid grid-cols-2 gap-3">
              <input 
                type="text" 
                id="card-expiry" 
                placeholder="–ú–ú/–ì–ì" 
                maxlength="5"
                class="px-4 py-3 text-sm uppercase tracking-wider"
                style="background: var(--panel-deep); border: 2px solid var(--accent-electric); color: var(--text-primary); letter-spacing: 1px; border-radius: 0;"
                onfocus="this.style.borderColor='var(--accent-electric)'; this.style.boxShadow='0 0 10px var(--glow-electric)';"
                onblur="this.style.borderColor='var(--accent-electric)'; this.style.boxShadow='none';"
                oninput="formatExpiry(this)">
              <input 
                type="text" 
                id="card-cvc" 
                placeholder="CVC" 
                maxlength="4"
                class="px-4 py-3 text-sm uppercase tracking-wider"
                style="background: var(--panel-deep); border: 2px solid var(--accent-electric); color: var(--text-primary); letter-spacing: 1px; border-radius: 0;"
                onfocus="this.style.borderColor='var(--accent-electric)'; this.style.boxShadow='0 0 10px var(--glow-electric)';"
                onblur="this.style.borderColor='var(--accent-electric)'; this.style.boxShadow='none';">
            </div>
            
            <input 
              type="text" 
              id="card-name" 
              placeholder="–ò–ú–Ø –í–õ–ê–î–ï–õ–¨–¶–ê" 
              class="w-full px-4 py-3 text-sm uppercase tracking-wider"
              style="background: var(--panel-deep); border: 2px solid var(--accent-electric); color: var(--text-primary); letter-spacing: 1px; border-radius: 0;"
              onfocus="this.style.borderColor='var(--accent-electric)'; this.style.boxShadow='0 0 10px var(--glow-electric)';"
              onblur="this.style.borderColor='var(--accent-electric)'; this.style.boxShadow='none';">
          </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã -->
        <button 
          type="button"
          onclick="processPayment()"
          id="pay-button"
          class="w-full py-4 text-base font-semibold uppercase tracking-wider transition-all"
          style="background: var(--accent-blue); color: var(--text-primary); border: none; border-radius: 0; letter-spacing: 1px; box-shadow: 0 6px 0 #001a4f;"
          onmouseover="this.style.transform='translateY(2px)'; this.style.boxShadow='0 4px 0 #001a4f';"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 0 #001a4f';"
          onmousedown="this.style.transform='translateY(4px)'; this.style.boxShadow='0 2px 0 #001a4f';"
          onmouseup="this.style.transform='translateY(2px)'; this.style.boxShadow='0 4px 0 #001a4f';">
          –û–ü–õ–ê–¢–ò–¢–¨ <span id="pay-button-price">-</span>
        </button>
        
        <p class="text-xs text-center" style="color: var(--text-muted);">
          üîí –ó–ê–©–ò–©–ï–ù–û SSL ‚Ä¢ –¢–û–ö–ï–ù–´ –ú–ì–ù–û–í–ï–ù–ù–û
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  let currentPackageId = null;
  let isPanelOpen = false;

  function openReplenishModal() {
    const modal = document.getElementById('replenish-modal');
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      resetSelection();
    }
  }

  function closeReplenishModal() {
    const modal = document.getElementById('replenish-modal');
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      resetSelection();
    }
  }

  function resetSelection() {
    // –£–±—Ä–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
    document.querySelectorAll('.package-card').forEach(card => {
      card.style.borderColor = 'var(--border-sharp)';
      card.style.boxShadow = 'none';
      const h4 = card.querySelector('h4');
      if (h4) h4.style.color = 'var(--text-primary)';
      const indicator = card.querySelector('.package-indicator');
      if (indicator) {
        indicator.style.transform = 'rotate(0deg)';
        indicator.style.color = 'var(--accent-electric)';
      }
    });
    
    // –ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
    closePanel();
    
    // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    currentPackageId = null;
    isPanelOpen = false;
  }

  function openPanel(packageId, packageName, price, accentColor, tokens) {
    // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ
    document.getElementById('selected-package-name').textContent = packageName;
    document.getElementById('selected-package-price').textContent = '$' + Math.round(price);
    document.getElementById('selected-package-tokens').textContent = tokens + ' —Ç–æ–∫–µ–Ω–æ–≤';
    document.getElementById('pay-button-price').textContent = '$' + Math.round(price);
    
    // –û–±–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç —Ü–µ–Ω—ã
    const priceEl = document.getElementById('selected-package-price');
    if (priceEl) {
      priceEl.style.color = accentColor;
    }
    
    // –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å - –≤—ã–µ–∑–∂–∞–µ—Ç —Å–ø—Ä–∞–≤–∞
    const panel = document.getElementById('payment-panel');
    const mainContent = document.getElementById('main-content');
    const container = document.getElementById('modal-container');
    
    if (panel && mainContent && container) {
      // –ü–∞–Ω–µ–ª—å –≤—ã–µ–∑–∂–∞–µ—Ç —Å–ø—Ä–∞–≤–∞
      panel.style.width = '450px';
      panel.style.borderLeftWidth = '1px';
      
      // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å–º–µ—â–∞–µ—Ç—Å—è –≤–ª–µ–≤–æ
      mainContent.style.width = 'calc(100% - 450px)';
      
      // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è
      container.style.maxWidth = '1000px';
    }
    
    isPanelOpen = true;
  }

  function closePanel() {
    const panel = document.getElementById('payment-panel');
    const mainContent = document.getElementById('main-content');
    const container = document.getElementById('modal-container');
    
    if (panel && mainContent && container) {
      // –ü–∞–Ω–µ–ª—å —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è
      panel.style.width = '0';
      panel.style.borderLeftWidth = '0';
      
      // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É
      mainContent.style.width = '100%';
      
      // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Ä–∞–∑–º–µ—Ä—É
      container.style.maxWidth = '768px';
    }
    
    isPanelOpen = false;
  }

  function togglePackage(packageId, packageName, price, accentColor, tokens) {
    // 1. –£–±—Ä–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
    document.querySelectorAll('.package-card').forEach(card => {
      const cardId = parseInt(card.dataset.packageId);
      
      if (cardId === packageId) {
        // –í—ã–¥–µ–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        if (currentPackageId === packageId && isPanelOpen) {
          // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ —Ç–æ—Ç –∂–µ —Ç–∞—Ä–∏—Ñ –∏ –ø–∞–Ω–µ–ª—å –æ—Ç–∫—Ä—ã—Ç–∞ - –∑–∞–∫—Ä—ã—Ç—å
          card.style.borderColor = 'var(--border-sharp)';
          card.style.boxShadow = 'none';
          const h4 = card.querySelector('h4');
          if (h4) h4.style.color = 'var(--text-primary)';
          const indicator = card.querySelector('.package-indicator');
          if (indicator) {
            indicator.style.transform = 'rotate(0deg)';
            indicator.style.color = 'var(--accent-electric)';
          }
          closePanel();
          currentPackageId = null;
        } else {
          // –í—ã–¥–µ–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
          card.style.borderColor = accentColor;
          const glowColor = accentColor.includes('electric') 
            ? 'rgba(0, 224, 255, 0.3)' 
            : 'rgba(47, 108, 255, 0.3)';
          card.style.boxShadow = `0 0 20px ${glowColor}`;
          const h4 = card.querySelector('h4');
          if (h4) h4.style.color = accentColor;
          const indicator = card.querySelector('.package-indicator');
          if (indicator) {
            indicator.style.transform = 'rotate(180deg)';
            indicator.style.color = accentColor;
          }
          // –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
          openPanel(packageId, packageName, price, accentColor, tokens);
          currentPackageId = packageId;
        }
      } else {
        // –£–±—Ä–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        card.style.borderColor = 'var(--border-sharp)';
        card.style.boxShadow = 'none';
        const h4 = card.querySelector('h4');
        if (h4) h4.style.color = 'var(--text-primary)';
        const indicator = card.querySelector('.package-indicator');
        if (indicator) {
          indicator.style.transform = 'rotate(0deg)';
          indicator.style.color = 'var(--accent-electric)';
        }
      }
    });
  }

  function applyPromoCode() {
    const code = document.getElementById('promo-code').value.trim().toUpperCase();
    if (code) {
      // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ-–∫–æ–¥–∞
      alert('–ü—Ä–æ–º–æ-–∫–æ–¥ "' + code + '" –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É');
    }
  }

  function formatCardNumber(input) {
    let value = input.value.replace(/\s/g, '');
    let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
    input.value = formatted;
  }

  function formatExpiry(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length >= 2) {
      value = value.substring(0, 2) + '/' + value.substring(2, 4);
    }
    input.value = value;
  }

  function processPayment() {
    const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
    const cardExpiry = document.getElementById('card-expiry').value;
    const cardCvc = document.getElementById('card-cvc').value;
    const cardName = document.getElementById('card-name').value;

    if (!cardNumber || !cardExpiry || !cardCvc || !cardName) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–∞—Ä—Ç—ã');
      return;
    }

    if (!currentPackageId) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ');
      return;
    }

    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    alert('–û–ø–ª–∞—Ç–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –ü–∞–∫–µ—Ç: ' + currentPackageId);
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if (isPanelOpen) {
        closePanel();
        resetSelection();
      } else {
        closeReplenishModal();
      }
    }
  });

  // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
  window.openReplenishModal = openReplenishModal;
  window.closeReplenishModal = closeReplenishModal;
  window.togglePackage = togglePackage;
  window.applyPromoCode = applyPromoCode;
  window.processPayment = processPayment;
  window.closePanel = closePanel;
</script>

<style>
  .package-indicator {
    transition: transform 0.3s ease, color 0.3s ease;
  }
  
  #modal-container {
    transition: max-width 0.3s ease;
  }
  
  #main-content {
    transition: width 0.3s ease;
  }
  
  .payment-panel {
    transition: width 0.3s ease, border-left-width 0.3s ease;
  }
  
  @media (max-width: 768px) {
    #modal-container {
      flex-direction: column;
    }
    
    #main-content {
      width: 100% !important;
    }
    
    .payment-panel {
      width: 100% !important;
      border-left: none !important;
      border-top: 1px solid var(--border-sharp) !important;
      max-height: 50vh;
    }
  }
</style>
